<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>RA V√≠deo</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 1000;
            display: none;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading-spinner" id="loadingSpinner"></div>
    <a-scene mindar-image="imageTargetSrc: ./src/files/targets.mind; maxTrack: 2" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false" id="arScene">
        <a-assets>
            <video id="video-1" playsinline webkit-playsinline crossorigin="anonymous"></video>
            <video id="video-2" playsinline webkit-playsinline crossorigin="anonymous"></video>

            <img id="thumbnail-1" crossorigin="anonymous">
            <img id="thumbnail-2" crossorigin="anonymous">
        </a-assets>

        <!-- Marcadores para cada p√°gina do livro -->
        <a-entity id="marker-1" mindar-image-target="targetIndex: 0">
            <a-video
                id="videoId-1"
                src="#video-1"
                width="1.8"
                height="3.2"
                position="0 0.1 0"
                rotation="0 0 0"
                visible="false"
                material="shader: flat; side: double">
            </a-video>
            <a-image
                id="thumbnailImg-1"
                src="#thumbnail-1"
                width="1.8"
                height="3.2"
                position="0 0.1 0"
                rotation="0 0 0"
                visible="true">
            </a-image>
        </a-entity>

        <a-entity id="marker-2" mindar-image-target="targetIndex: 1">
            <a-video
                id="videoId-2"
                src="#video-2"
                width="1.8"
                height="3.2"
                position="0 0.1 0"
                rotation="0 0 0"
                visible="false"
                material="shader: flat; side: double">
            </a-video>
            <a-image
                id="thumbnailImg-2"
                src="#thumbnail-2"
                width="1.8"
                height="3.2"
                position="0 0.1 0"
                rotation="0 0 0"
                visible="true">
            </a-image>
        </a-entity>

        <a-camera position="0 0 0" look-controls="enabled: false" wasd-controls="enabled: false;">
            <a-cursor intersection-spawn="event: click; targetEl: #marker"></a-cursor>
        </a-camera>
    </a-scene>

    <script>
        // Mapeamento dos arquivos para cada p√°gina (TESTE: apenas 2 targets)
        const arquivos = {
            1: {
                video: "./src/files/video1.mp4",
                thumb: "./src/files/thumb1.jpg"
            },
            2: {
                video: "./src/files/video2.mp4",
                thumb: "./src/files/thumb2.png"
            }
        };

        // Fun√ß√£o para verificar se arquivo existe
        function checkAssetExists(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
            });
        }

        // Fun√ß√£o para carregar todos os assets
        async function loadAssets() {
            const spinner = document.getElementById("loadingSpinner");
            spinner.style.display = "block";

            try {
                // Carrega apenas os 2 primeiros v√≠deos e thumbnails (TESTE)
                for (let i = 1; i <= 2; i++) {
                    const dados = arquivos[i];

                    // Verifica se thumbnail existe
                    const thumbExists = await checkAssetExists(dados.thumb);
                    if (thumbExists) {
                        document.getElementById(`thumbnail-${i}`).src = dados.thumb;
                    } else {
                        console.warn(`Thumbnail ${i} n√£o encontrada:`, dados.thumb);
                    }

                    // Define o v√≠deo
                    const videoElement = document.getElementById(`video-${i}`);
                    videoElement.src = dados.video;
                    console.log(`V√≠deo ${i} configurado:`, dados.video);
                }

                // Aguarda o MindAR inicializar
                const scene = document.getElementById("arScene");
                scene.addEventListener('renderstart', function() {
                    console.log('MindAR renderizado!');
                    setTimeout(() => {
                        spinner.style.display = "none";
                    }, 500);
                });

                // Timeout de seguran√ßa para remover spinner
                setTimeout(() => {
                    spinner.style.display = "none";
                    console.log('Spinner removido por timeout');
                }, 5000);

            } catch (error) {
                console.error("Erro ao carregar assets:", error);
                spinner.style.display = "none";
            }
        }

        // Carrega os assets
        loadAssets();

        // Otimiza√ß√µes para mobile
        const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);

        if (isMobile) {
            // For√ßa orienta√ß√£o retrato no mobile
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('portrait').catch(error => {
                    console.log('N√£o foi poss√≠vel bloquear orienta√ß√£o:', error);
                });
            }

            // Ajustes espec√≠ficos para iOS
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (isIOS) {
                // For√ßa contexto de intera√ß√£o para iOS
                document.addEventListener('touchstart', function() {}, {passive: true});
            }

            // Preload condicional baseado na conex√£o
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            const isSlowConnection = connection && (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g');

            if (!isSlowConnection) {
                // Em conex√µes boas, preload os v√≠deos silenciosamente
                for (let i = 1; i <= 2; i++) {
                    const video = document.getElementById(`video-${i}`);
                    if (video) video.preload = "metadata";
                }
            }

            // Configura√ß√µes espec√≠ficas para Android Chrome
            const isAndroid = /Android/i.test(navigator.userAgent);
            if (isAndroid) {
                // Adiciona CSS para controlar zoom da c√¢mera
                const style = document.createElement('style');
                style.textContent = `
                    #arjsDebugUIContainer { display: none !important; }
                    canvas {
                        transform-origin: center center !important;
                        object-fit: cover !important;
                        width: 100% !important;
                        height: 100% !important;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Controle de reprodu√ß√£o de v√≠deo para cada p√°gina
        const videoStates = {};

        // Rastreia quais targets est√£o vis√≠veis no momento
        const visibleTargets = {};

        // Inicializa estados dos v√≠deos (TESTE: apenas 2)
        for (let i = 1; i <= 2; i++) {
            videoStates[i] = {
                isPlaying: false,
                initialized: false
            };
            visibleTargets[i] = false;
        }

        // Fun√ß√£o para lidar com cliques nos elementos AR - OTIMIZADA PARA iOS
        async function handleARClick(pageNumber) {
            console.log(`üé¨ Click no marcador ${pageNumber}`);

            const video = document.getElementById(`video-${pageNumber}`);
            const videoEl = document.getElementById(`videoId-${pageNumber}`);
            const thumbnailEl = document.getElementById(`thumbnailImg-${pageNumber}`);

            const state = videoStates[pageNumber];

            if (!state.initialized) {
                console.log(`Primeira inicializa√ß√£o do v√≠deo ${pageNumber}`);

                // Esconde thumbnail
                thumbnailEl.setAttribute("visible", "false");

                // Aguarda um frame para garantir que o thumbnail foi escondido
                await new Promise(resolve => setTimeout(resolve, 50));

                // Mostra v√≠deo
                videoEl.setAttribute("visible", "true");

                console.log(`Estado do v√≠deo element:`, {
                    src: video.src,
                    readyState: video.readyState,
                    paused: video.paused,
                    width: video.videoWidth,
                    height: video.videoHeight
                });

                try {
                    // Garante que o v√≠deo est√° carregado
                    if (video.readyState < 2) {
                        console.log(`Carregando v√≠deo ${pageNumber}...`);
                        video.load();
                        await new Promise((resolve, reject) => {
                            video.addEventListener('loadeddata', resolve, {once: true});
                            video.addEventListener('error', reject, {once: true});
                            setTimeout(() => reject(new Error('Timeout ao carregar')), 10000);
                        });
                    }

                    // Reproduz o v√≠deo
                    console.log(`Tentando reproduzir v√≠deo ${pageNumber}...`);
                    await video.play();

                    console.log(`‚úÖ V√≠deo ${pageNumber} reproduzindo!`, {
                        paused: video.paused,
                        currentTime: video.currentTime,
                        duration: video.duration
                    });

                    state.isPlaying = true;
                    state.initialized = true;
                } catch (error) {
                    console.error(`‚ùå Erro ao reproduzir v√≠deo ${pageNumber}:`, error);
                    alert(`Erro ao carregar v√≠deo ${pageNumber}: ${error.message}`);

                    // Volta para thumbnail
                    thumbnailEl.setAttribute("visible", "true");
                    videoEl.setAttribute("visible", "false");
                }
            } else {
                // Toggle play/pause
                console.log(`Toggle play/pause do v√≠deo ${pageNumber}`);

                if (state.isPlaying) {
                    video.pause();
                    state.isPlaying = false;
                    console.log(`‚è∏Ô∏è V√≠deo ${pageNumber} pausado`);
                } else {
                    try {
                        await video.play();
                        state.isPlaying = true;
                        console.log(`‚ñ∂Ô∏è V√≠deo ${pageNumber} retomado`);
                    } catch (error) {
                        console.error(`‚ùå Erro ao retomar v√≠deo ${pageNumber}:`, error);
                    }
                }
            }
        }

        // Adiciona eventos de clique aos elementos AR
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Adiciona eventos para cada marcador (TESTE: apenas 2)
                for (let i = 1; i <= 2; i++) {
                    const marker = document.getElementById(`marker-${i}`);
                    const thumbnailImg = document.getElementById(`thumbnailImg-${i}`);
                    const videoId = document.getElementById(`videoId-${i}`);

                    if (marker) {
                        marker.addEventListener('click', () => handleARClick(i));
                        marker.addEventListener('touchstart', () => handleARClick(i));
                    }

                    if (thumbnailImg) {
                        thumbnailImg.addEventListener('click', () => handleARClick(i));
                        thumbnailImg.addEventListener('touchstart', () => handleARClick(i));
                    }

                    if (videoId) {
                        videoId.addEventListener('click', () => handleARClick(i));
                        videoId.addEventListener('touchstart', () => handleARClick(i));
                    }
                }

                // Log de debug para multi-target
                console.log('=== TESTE MULTI-TARGET ===');
                console.log('Arquivo: ./src/files/targets.mind');
                console.log('Targets configurados: 2');
                console.log('Target 0: exp01 -> Marcador 1');
                console.log('Target 1: exp02 -> Marcador 2');

                // Adiciona eventos de detec√ß√£o de targets
                for (let i = 1; i <= 2; i++) {
                    const marker = document.getElementById(`marker-${i}`);

                    marker.addEventListener('targetFound', function() {
                        console.log(`‚úÖ Target ${i} (exp0${i}) ENCONTRADO!`);
                        visibleTargets[i] = true;
                    });

                    marker.addEventListener('targetLost', function() {
                        console.log(`‚ùå Target ${i} (exp0${i}) PERDIDO`);
                        visibleTargets[i] = false;
                    });
                }

                // Click handler global - detecta qual target est√° vis√≠vel
                document.body.addEventListener('click', function(e) {
                    console.log('Click detectado no body');

                    // Verifica qual target est√° vis√≠vel
                    for (let i = 1; i <= 2; i++) {
                        if (visibleTargets[i]) {
                            console.log(`üëÜ Click processado para target vis√≠vel: ${i}`);
                            handleARClick(i);
                            return; // Processa apenas o primeiro vis√≠vel
                        }
                    }

                    console.log('‚ö†Ô∏è Nenhum target vis√≠vel no momento do click');
                }, {passive: false});

                // Touch handler para mobile
                document.body.addEventListener('touchstart', function(e) {
                    console.log('Touch detectado no body');

                    // Verifica qual target est√° vis√≠vel
                    for (let i = 1; i <= 2; i++) {
                        if (visibleTargets[i]) {
                            console.log(`üëÜ Touch processado para target vis√≠vel: ${i}`);
                            handleARClick(i);
                            return; // Processa apenas o primeiro vis√≠vel
                        }
                    }

                    console.log('‚ö†Ô∏è Nenhum target vis√≠vel no momento do touch');
                }, {passive: false});
            }, 2000);
        });
    </script>
</body>
</html>
