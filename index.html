<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>RA Vídeo</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 1000;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading-spinner" id="loadingSpinner"></div>
    <a-scene embedded arjs="patternRatio:0.90; cameraParametersUrl: data/camera_para.dat; detectionMode: mono_and_matrix; matrixCodeType: 3x3; debugUIEnabled: false; sourceType: webcam; sourceWidth: 1280; sourceHeight: 960; displayWidth: 1280; displayHeight: 960;" vr-mode-ui="enabled: false" renderer="antialias: false; precision: mediump;" id="arScene">
        <a-assets>
            <video id="video" playsinline></video>
            <img id="thumbnail">
        </a-assets>
        
        <a-marker id="marker" type="pattern" >
            <a-video id="videoId" src="#video" width="1.8" height="3.2" position="0 0 0" rotation="-90 0 0" visible="false"></a-video>
            <a-image id="thumbnailImg" src="#thumbnail" width="1.8" height="3.2" position="0 0 0" rotation="-90 0 0" visible="true"></a-image>
        </a-marker>
        
        <a-entity camera cursor="fuse: false; rayOrigin: mouse;"></a-entity>
    </a-scene>

    <script>
        // Captura a URL e obtém o parâmetro "code"
        const params = new URLSearchParams(window.location.search);
        const codeParam = params.get("code");
        
        // Validação do parâmetro code
        const validCodes = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"];
        const pagina = (codeParam && validCodes.includes(codeParam)) ? codeParam : "1";
        // Mapeamento dos arquivos para cada página
        const arquivos = {
            "1": {
                video: "./src/files/desafio.mp4",
                thumb: "./src/files/thumbnail.jpg",
                marcador: "./src/files/pattern-qr-code.patt"
            },
            "2": {
                video: "./src/files/video2.mp4",
                thumb: "./src/files/thumb2.jpg",
                marcador: "./src/files/pattern2.patt"
            },
            "3": {
                video: "./src/files/video3.mp4",
                thumb: "./src/files/thumb3.jpg",
                marcador: "./src/files/pattern3.patt"
            },
            "4": {
                video: "./src/files/video4.mp4",
                thumb: "./src/files/thumb4.jpg",
                marcador: "./src/files/pattern4.patt"
            },
            "5": {
                video: "./src/files/video5.mp4",
                thumb: "./src/files/thumb5.jpg",
                marcador: "./src/files/pattern5.patt"
            },
            "6": {
                video: "./src/files/video6.mp4",
                thumb: "./src/files/thumb6.jpg",
                marcador: "./src/files/pattern6.patt"
            },
            "7": {
                video: "./src/files/video7.mp4",
                thumb: "./src/files/thumb7.jpg",
                marcador: "./src/files/pattern7.patt"
            },
            "8": {
                video: "./src/files/video8.mp4",
                thumb: "./src/files/thumb8.jpg",
                marcador: "./src/files/pattern8.patt"
            },
            "9": {
                video: "./src/files/video9.mp4",
                thumb: "./src/files/thumb9.jpg",
                marcador: "./src/files/pattern9.patt"
            },
            "10": {
                video: "./src/files/video10.mp4",
                thumb: "./src/files/thumb10.jpg",
                marcador: "./src/files/pattern10.patt"
            }
        };    

        // Obtém os arquivos correspondentes à página atual
        const dadosPagina = arquivos[pagina];

        // Função para verificar se arquivo existe
        function checkAssetExists(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
            });
        }

        // Função para carregar assets com tratamento de erro
        async function loadAssets() {
            const spinner = document.getElementById("loadingSpinner");
            spinner.style.display = "block";
            
            try {
                // Verifica se thumbnail existe
                const thumbExists = await checkAssetExists(dadosPagina.thumb);
                if (thumbExists) {
                    document.getElementById("thumbnail").src = dadosPagina.thumb;
                } else {
                    console.warn("Thumbnail não encontrada:", dadosPagina.thumb);
                }

                // Define o vídeo (será carregado quando clicado)
                document.getElementById("video").src = dadosPagina.video;
                
                // Define o marcador
                document.getElementById("marker").setAttribute("url", dadosPagina.marcador);
                
                // Esconde o spinner quando terminar
                spinner.style.display = "none";
            } catch (error) {
                console.error("Erro ao carregar assets:", error);
                spinner.style.display = "none";
            }
        }

        // Carrega os assets
        loadAssets();
        
        // Otimizações para mobile
        const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
        
        if (isMobile) {
            // Força orientação retrato no mobile
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('portrait').catch(error => {
                    console.log('Não foi possível bloquear orientação:', error);
                });
            }
            
            // Ajustes específicos para iOS
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (isIOS) {
                // Força contexto de interação para iOS
                document.addEventListener('touchstart', function() {}, {passive: true});
            }
            
            // Preload condicional baseado na conexão
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            const isSlowConnection = connection && (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g');
            
            if (!isSlowConnection) {
                // Em conexões boas, preload o vídeo silenciosamente
                const video = document.getElementById("video");
                video.preload = "metadata";
            }
            
            // Configurações específicas para Android Chrome
            const isAndroid = /Android/i.test(navigator.userAgent);
            if (isAndroid) {
                // Força configurações de câmera para evitar zoom
                setTimeout(() => {
                    const arScene = document.getElementById("arScene");
                    arScene.setAttribute('arjs', 'patternRatio:0.90; sourceWidth:640; sourceHeight:480; displayWidth:640; displayHeight:480; cameraParametersUrl: data/camera_para.dat;');
                }, 1000);
            }
        }
        
        // Controle de reprodução de vídeo
        let isVideoPlaying = false;
        let videoInitialized = false;

        window.addEventListener("click", async () => {
            const video = document.getElementById("video");
            const videoId = document.getElementById("videoId");
            const thumbnailImg = document.getElementById("thumbnailImg");
            const spinner = document.getElementById("loadingSpinner");

            if (!videoInitialized) {
                // Primeira execução: mostra spinner e carrega vídeo
                spinner.style.display = "block";
                thumbnailImg.setAttribute("visible", false);
                videoId.setAttribute("visible", true);
                
                try {
                    // Aguarda o vídeo carregar completamente antes de reproduzir
                    video.load();
                    
                    // Timeout para evitar loading infinito
                    const loadTimeout = setTimeout(() => {
                        spinner.style.display = "none";
                        console.warn("Timeout no carregamento do vídeo");
                    }, 15000);
                    
                    // Aguarda o vídeo estar pronto
                    await new Promise((resolve, reject) => {
                        video.addEventListener('loadedmetadata', resolve, {once: true});
                        video.addEventListener('error', reject, {once: true});
                    });
                    
                    clearTimeout(loadTimeout);
                    spinner.style.display = "none";
                    
                    await video.play();
                    isVideoPlaying = true;
                    videoInitialized = true;
                } catch (error) {
                    spinner.style.display = "none";
                    console.error("Erro ao carregar/reproduzir o vídeo:", error);
                    // Volta para thumbnail em caso de erro
                    thumbnailImg.setAttribute("visible", true);
                    videoId.setAttribute("visible", false);
                }
            } else {
                // Execuções subsequentes: toggle play/pause
                if (isVideoPlaying) {
                    video.pause();
                    isVideoPlaying = false;
                } else {
                    try {
                        await video.play();
                        isVideoPlaying = true;
                    } catch (error) {
                        console.error("Erro ao reproduzir o vídeo:", error);
                    }
                }
            }
        });
    </script>
</body>
</html>
